# Документация по приложению ExcelFlow

## Содержание
1. [Общее описание](#общее-описание)
2. [Функциональные возможности](#функциональные-возможности)
3. [Архитектура приложения](#архитектура-приложения)
4. [Установка и настройка](#установка-и-настройка)
5. [Использование](#использование)
6. [Описание алгоритмов](#описание-алгоритмов)
7. [Логирование](#логирование)
8. [Тестирование](#тестирование)

## Общее описание

ExcelFlow - это консольное приложение на Python для автоматического анализа Excel-файла с несколькими вкладками. Приложение сопоставляет данные между вкладками по определённым критериям и добавляет результаты расчёта в целевую вкладку без потери исходного форматирования.

Основная цель приложения - подтянуть данные о прямой себестоимости из справочной вкладки во вкладку обработки и создать новый столбец с рассчитанными значениями.

## Функциональные возможности

- Извлечение и нормализация дат из документа приобретения
- Определение квартала на основе даты
- Сопоставление данных по двум уровням:
  - Уровень 1: При наличии полной даты приобретения (сопоставление по номенклатуре и периоду)
  - Уровень 2: При отсутствии полной даты приобретения (сопоставление по коду номенклатуры и контрагенту)
- Добавление трёх новых столбцов в вкладку "СК ТПХ_1 пг":
  - "Дата приобретения"
  - "Квартал приобретения"
 - "Рассчитанная себестоимость"
- Поддержка размытого сравнения для неточных совпадений
- Подробное логирование процесса обработки
- Генерация отчетов о несопоставленных записях

## Архитектура приложения

### Структура проекта
```
ExcelFlow/
├── main.py                 # Точка входа, парсинг аргументов
├── processors/
│   ├── __init__.py
│   ├── data_loader.py      # Загрузка и валидация файлов
│   ├── parser.py           # Парсинг и нормализация данных
│   └── matcher.py          # Логика сопоставления
├── utils/
│   ├── __init__.py
│   ├── date_extractor.py   # Извлечение и парсинг дат
│   ├── fuzzy_matcher.py    # "Размытое" сравнение
│   └── logger_config.py    # Конфигурация логирования
├── tests/
│   ├── test_parser.py
│   ├── test_matcher.py
│   └── test_date_extractor.py
├── requirements.txt        # Зависимости проекта
├── README.md               # Краткая документация
└── DOCUMENTATION.md        # Полная документация
```

### Модули приложения

#### processors/data_loader.py
Класс `DataLoader` отвечает за загрузку и валидацию Excel-файла. Проверяет наличие обязательных вкладок и столбцов, обеспечивает корректное чтение данных.

#### processors/parser.py
Класс `DataParser` выполняет парсинг и нормализацию данных в обеих вкладках:
- Извлечение дат из документов
- Нормализация номенклатур
- Извлечение кодов номенклатур
- Преобразование периодов в диапазоны дат

#### processors/matcher.py
Класс `DataMatcher` реализует основную логику сопоставления записей между вкладками:
- Уровень 1: Сопоставление с датой приобретения
- Уровень 2: Сопоставление без даты приобретения
- Размытое сопоставление
- Приоритизация совпадений

#### utils/date_extractor.py
Функции для извлечения и обработки дат:
- `extract_date_from_document()` - извлечение даты из строки документа
- `determine_quarter()` - определение квартала по дате
- `parse_period_to_date_range()` - преобразование периода в диапазон дат

#### utils/fuzzy_matcher.py
Функции для размытого сравнения:
- `normalize_nomenclature()` - нормализация строк номенклатур
- `extract_nomenclature_code()` - извлечение кодов номенклатур
- `fuzzy_match_similarity()` - вычисление коэффициента схожести
- `fuzzy_match_candidates()` - поиск потенциальных совпадений

#### utils/logger_config.py
Функции для настройки использования логирования:
- `setup_logger()` - настройка логгера
- `log_application_start()` - логирование начала работы
- `log_sheet_info()` - логирование информации о вкладках
- `log_processing_progress()` - логирование прогресса
- `log_final_stats()` - логирование итоговой статистики

## Установка и настройка

### Требования
- Python 3.8+
- См. файл `requirements.txt` для списка зависимостей

### Установка зависимостей
```bash
pip install -r requirements.txt
```

## Использование

### Командный интерфейс
```bash
python main.py --input <путь> --output <путь> [--source-sheet] [--target-sheet] [--log-level] [--report-file]
```

### Параметры

| Параметр | Тип | Описание | Обязательный |
|----------|-----|---------|------------|
| `--input` | string | Путь к входному Excel-файлу | Да |
| `--output` | string | Путь к выходному Excel-файлу | Да |
| `--source-sheet` | string | Имя вкладки-справочника | Нет (по умолчанию: "ВП 2024-2025 НЧТЗ") |
| `--target-sheet` | string | Имя вкладки для обработки | Нет (по умолчанию: "СК ТПХ_1 пг") |
| `--log-level` | string | Уровень логирования (DEBUG, INFO, WARNING, ERROR) | Нет (по умолчанию: INFO) |
| `--report-file` | string | Путь к файлу отчёта о несопоставленных записях | Нет |

### Примеры использования

```bash
# Базовое использование
python main.py --input данные.xlsx --output результат.xlsx

# С пользовательским путём отчёта
python main.py --input данные.xlsx --output результат.xlsx --report-file отчет.xlsx

# С повышенным уровнем логирования
python main.py --input данные.xlsx --output результат.xlsx --log-level DEBUG
```

## Описание алгоритмов

### Алгоритм обработки

#### Этап 1: Инициализация и валидация
1. Проверить существование входного файла
2. Открыть файл и загрузить все вкладки в памяти
3. Проверить наличие обязательных вкладок: "СК ТПХ_1 пг" и "ВП 2024-2025 НЧТЗ"
4. Валидировать наличие обязательных столбцов в каждой вкладке

#### Этап 2: Нормализация и подготовка данных

##### Вкладка "СК ТПХ_1 пг":
1. **Извлечение и парсинг даты приобретения:**
   - Исходный формат в столбце V (например): `"Реализация товаров и услуг 00КА-000135 от 20.01.2025 23:59:59"`
   - Использовать регулярное выражение: `r'от\s+(\d{2}\.\d{2}\.\d{4})(?:\s+(\d{2}:\d{2}:\d{2}))?'`
   - Преобразовать в формат: `datetime(2025, 1, 20)`
   - Если парсинг не удался — заполнить как "Дата не найдена"

2. **Определение квартала на основе даты:**
   - Q1: январь–март (месяцы 1–3)
   - Q2: апрель–июнь (месяцы 4–6)
   - Q3: июль–сентябрь (месяцы 7–9)
   - Q4: октябрь–декабрь (месяцы 10–12)

3. **Нормализация номенклатуры:**
   - Удалить ведущие/хвостовые пробелы
   - Привести к единому регистру (нижний)
   - Удалить дублирующиеся пробелы (заменить на один)

4. **Извлечение кода номенклатуры (если доступен):**
   - Использовать регулярное выражение: `r'([А-ЯЁ]+\.?\d+\.?\d+(?:-\d+)?)'` для кириллицы
   - Или: `r'(\d+\.\d+\.\d+(?:-\d+)*)'` для цифровых кодов

##### Вкладка "ВП 2024-2025 НЧТЗ":
1. **Нормализация номенклатуры:**
   - Применить те же правила нормализации, что и для исходной вкладки

2. **Парсинг периода месяца:**
   - Исходный формат: "Декабрь 2024 г.", "Январь 2025 г."
   - Преобразовать в: `{"месяц": 12, "год": 2024}`
   - Или виде диапазона дат: `[2024-12-01, 2024-12-31]`

3. **Извлечение значения себестоимости:**
   - Столбец AR ("Прямая СС на ед") — основное значение
   - Столбец AQ ("Стоимость закупки НЧТ") — для приоритизации при множественных совпадениях
   - Столбец AS ("Прямая материальная составляющая") — резервный (если AR пуст)

#### Этап 3: Сопоставление записей

Для каждой строки вкладки "СК ТПХ_1 пг":

1. **Проверить наличие извлеченной даты приобретения:**
   - Если дата найдена → перейти к алгоритму Уровня 1
   - Если дата не найдена → перейти к алгоритму Уровня 2

2. **Уровень 1 (с датой):**
   - Профильтровать строки в "ВП 2024-2025 НЧТЗ" по периоду (должен содержать извлеченную дату)
   - Из отфильтрованного списка найти строку с точным совпадением номенклатуры
   - Если есть совпадение → записать значение AR, перейти к следующей строке
   - Если нет точного совпадения → применить "размытое" сравнение

3. **Уровень 2 (без даты):**
   - Извлечь код номенклатуры из текущей строки
   - Поискать в "ВП 2024-2025 НЧТЗ" строки, содержащие этот код
   - Отфильтровать по контрагенту (если применимо)
   - Выбрать квартал на основе даты реализации и отфильтровать по периоду
   - Если есть совпадение → записать значение, перейти к следующей строке
   - Если совпадений несколько → применить приоритизацию
   - Если совпадений нет → записать маркер ошибки

### Приоритизация совпадений

Когда найдено несколько совпадений, выбрать одно по следующему приоритету (в порядке убывания важности):

1. Совпадение по **всем трём параметрам** (номенклатура + контрагент + период)
2. Совпадение по **номенклатуре + периоду** (наиболее критично)
3. Совпадение по **коду номенклатуры + периоду**
4. Совпадение с **наиболее близкой датой** (±7 дней от исходной)
5. При равных условиях — выбрать запись с **наименьшей стоимостью закупки** (столбец AQ) или наибольшей ценой реализации

### Особые случаи

#### Когда соответствие не найдено
- Заполнить столбец "Рассчитанная себестоимость" значением: `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*`
- Добавить запись в лог для последующего анализа

#### При отсутствии ключевых данных
- Если нет ни даты приобретения, ни даты реализации — метка: `*ОТСУТСТВУЮТ КЛЮЧЕВЫЕ ДАТЫ*`
- Если есть только контрагент, но нет номенклатуры — метка: `*НЕПОЛНЫЕ ДАННЫЕ: ТРЕБУЕТСЯ КОД НОМЕНКЛАТУРЫ*`

## Логирование

Приложение выводит в консоль и в файл лога следующую информацию:

1. **На этапе инициализации:**
   - Версия приложения и время запуска
   - Проверка входного файла
   - Список найденных вкладок
   - Количество строк в каждой вкладке

2. **На этапе обработки (INFO уровень):**
   - Прогресс обработки (каждые N записей: 0%, 25%, 50%, 75%, 100%)
   - Статистика по видам совпадений (точное, Уровень 1, Уровень 2, размытое)

3. **На этапе обработки (DEBUG уровень):**
   - Детальная информация о каждом сопоставлении
   - Полученные коэффициенты совпадения
   - Отброшенные кандидаты и причины

4. **По итогам обработки:**
   - **Общая статистика:**
     - Всего обработано записей: N
     - Успешно сопоставлено: M (%)
     - Требует ручной проверки: K (%)
     - Отсутствуют ключевые данные: L (%)
   - **Распределение по типам совпадений:**
     - Точное совпадение: X
     - Совпадение по Уровню 1: Y
     - Совпадение по Уровню 2: Z
     - Размытое совпадение: W
   - **Время обработки:** HH:MM:SS

Пример формата лога:
```
[2025-01-20 10:15:30] INFO: ============ ExcelFlow v1.0 ============
[2025-01-20 10:15:30] INFO: Входной файл: /home/user/данные.xlsx
[2025-01-20 10:15:30] INFO: Найдено вкладок: 7
[2025-01-20 10:15:30] INFO: Начало обработки...
[2025-01-20 10:15:35] INFO: Обработано: 25% (250 из 1000)
[2025-01-20 10:15:40] INFO: Обработано: 50% (500 из 1000)
[2025-01-20 10:15:45] INFO: Обработано: 75% (750 из 1000)
[2025-01-20 10:15:50] INFO: Обработано: 100% (100 из 1000)
[2025-01-20 10:15:51] INFO: ========== ИТОГОВАЯ СТАТИСТИКА ==========
[2025-01-20 10:15:51] INFO: Успешно сопоставлено: 950 (95.0%)
[2025-01-20 10:15:51] INFO: Требует ручной проверки: 45 (4.5%)
[2025-01-20 10:15:51] INFO: Ошибки/отсутствуют данные: 5 (0.5%)
[2025-01-20 10:15:51] INFO: Точное совпадение: 800
[2025-01-20 10:15:51] INFO: Совпадение Уровень 1: 100
[2025-01-20 10:15:51] INFO: Совпадение Уровень 2: 50
[2025-01-20 10:15:51] INFO: Размытое совпадение: 0
[2025-01-20 10:15:51] INFO: Время обработки: 00:00:21
```

## Тестирование

### Структура тестов

#### tests/test_date_extractor.py
Тесты для модуля извлечения дат:
- `test_extract_date_from_document_standard_format()` - тест парсинга стандартного формата даты
- `test_extract_date_from_document_invalid_format()` - тест обработки некорректного формата даты
- `test_determine_quarter()` - тест определения квартала по дате
- `test_parse_period_to_date_range()` - тест преобразования периода в диапазон дат

#### tests/test_parser.py
Тесты для модуля парсинга:
- `test_nomenclature_normalization()` - тест нормализации номенклатур
- `test_quarter_determination()` - тест определения квартала
- `test_nomenclature_code_extraction()` - тест извлечения кодов номенклатур
- `test_parse_target_sheet()` - тест парсинга целевой вкладки
- `test_parse_source_sheet()` - тест парсинга справочной вкладки

#### tests/test_matcher.py
Тесты для модуля сопоставления:
- `test_exact_match_with_date()` - тест точного совпадения с датой приобретения
- `test_match_by_code_without_date()` - тест сопоставления по коду без даты приобретения
- `test_no_match_manual_review()` - тест отсутствия совпадения и отправки на ручную проверку