Техническое задание на разработку приложения для анализа Excel-файла

## 1. Общее описание
Разработать приложение для автоматического анализа Excel-файла с несколькими вкладками, которое будет сопоставлять данные между вкладками по определенным критериям и добавлять результаты расчета в целевую вкладку.

## 2. Входные данные
- Excel-файл с несколькими вкладками, включая:
  - "СК ТПХ_1 пг" (основная вкладка для обработки)
  - "ВП 2024-2025 НЧТЗ" (источник данных о себестоимости)
  - Другие вкладки с продажами за разные периоды

## 3. Функциональные требования

### 3.1. Основная задача
Подтянуть данные о прямой себестоимости из вкладки "ВП 2024-2025 НЧТЗ" во вкладку "СК ТПХ_1 пг" и создать новый столбец с этими данными в конце таблицы.

### 3.2. Логика сопоставления данных
Приложение должно реализовать следующую логику сопоставления:

1. **При наличии даты приобретения** (столбец ?? во вкладке "СК ТПХ_1 пг"):
   - Сопоставить записи по двум параметрам:
     - Номенклатура закупки (столбец S во вкладке "СК ТПХ_1 пг") ↔ Номенклатура завода (столбец I во вкладке "ВП 2024-2025 НЧТЗ")
     - Дата приобретения (извлечена из столбца ?? во вкладке "СК ТПХ_1 пг") ↔ Период месяц (столбец B во вкладке "ВП 2024-2025 НЧТЗ")

2. **При отсутствии даты приобретения**:
   - Сопоставить записи по:
     - Частичному совпадению номенклатуры (используя уникальные коды в названии)
     - Контрагенту "СК ТПХ" (НАПРИМЕР Договор № 1225-СК ТПХ) или "СК Татпром-холдинг" (столбец F во вкладке "ВП 2024-2025 НЧТЗ")
     - Периоду реализации (столбец B во вкладке "ВП 2024-2025 НЧТЗ"), определенному на основе даты из столбца D во вкладке "СК ТПХ_1 пг"

3. **Особые случаи**:
   - Если соответствие не найдено, пометить ячейку специальным значением "*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*"
   - Для записей с отсутствующей датой приобретения добавить отдельную пометку для последующего ручного анализа

### 3.3. Алгоритм обработки и сопоставления

1. **Извлечение даты приобретения**:
   - Распарсить значение из столбца V?? ("Документ приобретения") во вкладке "СК ТПХ_1 пг"
   - Извлечь дату из строки в формате "Реализация товаров и услуг 00КА-000135 от 20.01.2025 23:59:59"
   - Преобразовать в формат, пригодный для сопоставления

2. **Обработка наименований номенклатуры**:
   - Использовать регулярные выражения для поиска уникальных кодов в названиях:
     - Шаблон поиска: `\d+\.\d+\.\d+-.*` (и подобные паттерны кодов)
     - Пример: поиск "0.0.0-0-0.0-0-32.23.0-28" в названии муфты
   - При отсутствии полного совпадения названия, использовать частичное совпадение по уникальному коду

3. **Определение квартала**:
   - На основе даты реализации определить квартал (1, 2, 3 или 4)
   - Использовать этот параметр для фильтрации записей во вкладке "ВП 2024-2025 НЧТЗ"

### 3.4. Формирование результата
- Создать новый столбец справа от последнего столбца во вкладке "СК ТПХ_1 пг"
- Название столбца: "Рассчитанная себестоимость"
- Заполнить столбец значениями из столбца AR ("Прямая СС на ед") вкладки "ВП 2024-2025 НЧТЗ"
- Для несопоставленных строк указать "*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*"

## 4. Технические требования

1. **Язык программирования**: Python (предпочтительно) или другой язык с хорошей поддержкой работы с Excel
2. **Библиотеки**:
   - pandas для обработки табличных данных
   - openpyxl или xlsxwriter для работы с Excel
   - re для работы с регулярными выражениями
3. **Интерфейс**:
   - Консольное приложение с параметрами:
     - Путь к входному файлу
     - Путь к выходному файлу
   - Возможность указания имен вкладок для обработки
4. **Логирование**:
   - Вывод статистики по обработанным записям
   - Указание количества успешно сопоставленных и несопоставленных записей
   - Детальный лог для записей, требующих ручной проверки

## 5. Требования к обработке особых ситуаций

1. **Несколько совпадений**:
   - Если для одной записи найдено несколько совпадений, выбрать запись с наиболее близкой датой
   - При равных условиях выбрать запись с наибольшей ценой закупки

2. **Отсутствие полных данных**:
   - Если отсутствует дата приобретения и невозможно однозначно определить соответствие, пометить запись специальным маркером
   - Создать отдельный отчет с такими записями для ручной обработки

3. **Различие в наименованиях**:
   - Учитывать различия в форматировании названий (например, "подгоночных" vs "подг")
   - Использовать "размытое" сравнение для критических частей названий

## 6. Дополнительные требования

1. **Производительность**:
   - Обработка файла с 1000+ строками должна занимать не более 2 минут
   - Оптимизация алгоритма для работы с большими объемами данных

2. **Сохранение форматирования**:
   - Сохранить исходное форматирование ячеек в выходном файле
   - Новый столбец должен иметь форматирование, соответствующее соседним столбцам

3. **Тестирование**:
   - Разработать тестовые наборы для проверки корректности сопоставления
   - Включить в решение минимум 3 тестовых сценария

## 7. Ожидаемый результат
- Excel-файл с добавленным столбцом "Рассчитанная себестоимость" во вкладке "СК ТПХ_1 пг"
- Отчет о количестве успешно обработанных записей
- Файл с перечнем записей, требующих ручной проверки

## 8. Пример обработки
Для записи во вкладке "СК ТПХ_1 пг":
- Номенклатура закупки: "Башмак колонный вращающийся БК-Вр.114"
- Документ приобретения: "Реализация товаров и услуг 00КА-000135 от 20.01.2025 23:59:59"

Система должна найти соответствующую запись во вкладке "ВП 2024-2025 НЧТЗ":
- Номенклатура завода: "Башмак колонный вращающийся БК-Вр.114"
- Период месяц: январь 2025
- И скопировать значение из столбца AR в новый столбец во вкладке "СК ТПХ_1 пг"

