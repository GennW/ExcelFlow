# Техническое задание: Приложение для анализа и сопоставления данных Excel

## 1. Общее описание

Разработать консольное приложение на Python для **автоматического анализа Excel-файла с несколькими вкладками**. Приложение должно сопоставлять данные между вкладками по определённым критериям и добавлять результаты расчёта в целевую вкладку без потери исходного форматирования.

**Основная цель:** подтянуть данные о прямой себестоимости из справочной вкладки во вкладку обработки и создать новый столбец с рассчитанными значениями.

---

## 2. Входные данные

Excel-файл Материалы/СК_ТПХпродажи_1_пг_2025.xlsx  с несколькими вкладками:

| Вкладка | Назначение |
|---------|-----------|
| "СК ТПХ_1 пг" | Основная вкладка для обработки (содержит заказы и поставки) |
| "ВП 2024-2025 НЧТЗ" | Справочная вкладка с данными о себестоимости |
| Прочие вкладки | Исторические данные по продажам за разные периоды |

---

## 3. Функциональные требования

### 3.1 Основная задача

Создать пять новых столбцов в конце таблицы вкладки **"СК ТПХ_1 пг"**:

- **Столбец 1: "Дата приобретения"** — извлеченная и нормализованная дата из документа приобретения
- **Столбец 2: "Квартал приобретения"** — определённый на основе даты квартал (1, 2, 3 или 4 в формате "N квартал YYYY")
- **Столбец 3: "Стоимость закупки НЧТЗ 1 ед"** — значение из столбца AQ справочной вкладки или маркер ошибки
- **Столбец 4: "Прямая СС НЧТЗ 1 ед"** — значение из столбца AR справочной вкладки или маркер ошибки
- **Столбец 5: "НР НЧТЗ 1 ед"** — значение из столбца AS справочной вкладки или маркер ошибки

### 3.2 Логика сопоставления данных

Приложение должно использовать **двухуровневый алгоритм** сопоставления:

#### Уровень 1: При наличии полной даты приобретения

Если в столбце документа приобретения удалось извлечь дату, сопоставлять по **двум параметрам одновременно**:

1. **Номенклатура:**
   - Источник: столбец S ("Номенклатура закупки") вкладки "СК ТПХ_1 пг"
   - Цель: столбец I ("Номенклатура завода") вкладки "ВП 2024-2025 НЧТЗ"
   - Правило: точное совпадение после нормализации (удаление лишних пробелов, приведение к одному регистру)

2. **Период:**
   - Источник: извлеченная дата из столбца документа приобретения
   - Цель: столбец B ("Период месяц") вкладки "ВП 2024-2025 НЧТЗ"
   - Правило: дата должна попадать в диапазон месяца, указанного в "Период месяц"

#### Уровень 2: При отсутствии полной даты приобретения

Если дата не извлеклась или формат некорректен, использовать **альтернативный алгоритм**:

1. **Поиск по коду номенклатуры:**
   - Использовать регулярное выражение для поиска уникальных кодов в названии (например: `ОНГ\.216\.00\.000-01-032` или `МШГРП\.114\.015` или `0.0.0-0-0.0-0-32.23.0-28`)
   - Вытащить такой код из названия в "СК ТПХ_1 пг"
   - Найти в "ВП 2024-2025 НЧТЗ" строку, содержащую этот же код

2. **Контрагент:**
   - Проверить, содержит ли контрагент из документа ключевые слова "СК ТПХ" или "СК Татпром-холдинг"
   - Столбец для проверки: F ("Контрагент" или "Регистратор") вкладки "ВП 2024-2025 НЧТЗ"

3. **Дата реализации как альтернатива:**
   - Извлечь дату реализации из столбца D вкладки "СК ТПХ_1 пг"
   - Определить квартал на основе этой даты
   - Сопоставить по периоду в столбце B вкладки "ВП 2024-2025 НЧТЗ"

### 3.3 Особые случаи и приоритизация

#### Когда найдено несколько совпадений

Выбрать одно по следующему приоритету (в порядке убывания важности):

1. Совпадение по **всем трём параметрам** (номенклатура + контрагент + период)
2. Совпадение по **номенклатуре + периоду** (наиболее критично)
3. Совпадение по **коду номенклатуры + периоду**
4. Совпадение с **наиболее близкой датой** (±7 дней от исходной)
5. При равных условиях — выбрать запись с **наибольшей стоимостью закупки** (столбец AQ) или наибольшей ценой реализации

#### Когда соответствие не найдено

- Заполнить столбец "Рассчитанная себестоимость" значением: `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*`
- Заполнить столбцы "Стоимость закупки НЧТЗ 1 ед", "Прямая СС НЧТЗ 1 ед", "НР НЧТЗ 1 ед" значением: `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*`
- Добавить запись в лог для последующего анализа (см. раздел 3.6)

#### При отсутствии ключевых данных

- Если нет ни даты приобретения, ни даты реализации — метка: `*ОТСУТСТВУЮТ КЛЮЧЕВЫЕ ДАТЫ*`
- Если есть только контрагент, но нет номенклатуры — метка: `*НЕПОЛНЫЕ ДАННЫЕ: ТРЕБУЕТСЯ КОД НОМЕНКЛАТУРЫ*`

---

## 4. Алгоритм обработки

### 4.1 Этап 1: Инициализация и валидация

1. Проверить существование входного файла
2. Открыть файл и загрузить все вкладки в памяти
3. Проверить наличие обязательных вкладок: "СК ТПХ_1 пг" и "ВП 2024-2025 НЧТЗ"
4. Валидировать наличие обязательных столбцов в каждой вкладке

### 4.2 Этап 2: Нормализация и подготовка данных

#### Вкладка "СК ТПХ_1 пг":

1. **Извлечение и парсинг даты приобретения:**
   - Исходный формат в столбце V (например): `"Реализация товаров и услуг 00КА-000135 от 20.01.2025 23:59:59"`, `"Приобретение товаров и услуг 00КА-001861 от 28.06.2024 0:00:00"`, `"Внутренняя накладная 00КА-000054 от 31.12.2023 23:59:59"`
   - Использовать регулярные выражения: `r'Приобретение товаров и услуг.*?от\s+(\d{2}\.\d{2}\.\d{4})'`, `r'Внутренняя накладная.*?от\s+(\d{2}\.\d{2}\.\d{4})'`, `r'Реализация товаров и услуг.*?от\s+(\d{2}\.\d{2}\.\d{4})'`
   - Преобразовать в формат: `datetime(2025, 1, 20)`
   - Если парсинг не удался — заполнить как "Дата не найдена"

2. **Определение квартала на основе даты:**
   - Формат: "1 квартал 2025", "2 квартал 2024"
   - Пример: 15.02.2025 → "1 квартал 2025"

3. **Нормализация номенклатуры:**
   - Удалить ведущие/хвостовые пробелы
   - Привести к единому регистру (нижний)
   - Удалить дублирующиеся пробелы (заменить на один)

4. **Извлечение кода номенклатуры (если доступен):**
   - Использовать регулярные выражения: `r'[А-ЯЁ]+\.\d+\.\d+\.\d+(?:-\d+)*'`, `r'[А-ЯЁ]+\.\d+\.\d+(?:-[\d\.,]+)*'`, `r'\d+\.\d+\.\d+(?:-.*)?'`, `r'[А-ЯЁ]{2,4}-[А-ЯЁ]{2,4}\.\d+'`
   - Пример: `ОНГ.216.00.000-01-032`, `МШГРП.114.015-032-60,00`, `0.0.0-0-0.0-0-32.23.0-28`, `БК-Вр.114`

#### Вкладка "ВП 2024-2025 НЧТЗ":

1. **Нормализация номенклатуры:**
   - Применить те же правила нормализации, что и для исходной вкладки

2. **Парсинг периода месяца:**
   - Исходный формат: "Декабрь 2024 г.", "Январь 2025 г."
   - Преобразовать в: `{"месяц": 12, "год": 2024}`
   - Или в виде диапазона дат: `[2024-12-01, 2024-12-31]`

3. **Извлечение значений себестоимости:**
   - Столбец AR ("Прямая СС на ед") — основное значение
   - Столбец AQ ("Стоимость закупки НЧТ") — для приоритизации при множественных совпадениях
   - Столбец AS ("Прямая материальная составляющая") — резервный (если AR пуст)

### 4.3 Этап 3: Сопоставление записей

Для каждой строки вкладки "СК ТПХ_1 пг":

1. **Проверить наличие извлеченной даты приобретения:**
   - Если дата найдена → перейти к алгоритму Уровня 1
   - Если дата не найдена → перейти к алгоритму Уровня 2

2. **Уровень 1 (с датой):**
   - Профильтровать строки в "ВП 2024-2025 НЧТЗ" по периоду (должен содержать извлеченную дату)
   - Из отфильтрованного списка найти строку с точным совпадением номенклатуры
   - Если есть совпадение → записать значения AQ, AR, AS, перейти к следующей строке
   - Если нет точного совпадения → применить "размытое" сравнение (см. 4.4)

3. **Уровень 2 (без даты):**
   - Извлечь код номенклатуры из текущей строки
   - Поискать в "ВП 2024-2025 НЧТЗ" строки, содержащие этот код
   - Отфильтровать по контрагенту (если применимо)
   - Выбрать квартал на основе даты реализации и отфильтровать по периоду
   - Если есть совпадение → записать значения AQ, AR, AS, перейти к следующей строке
   - Если совпадений несколько → применить приоритизацию (см. 4.5)
   - Если совпадений нет → записать маркер ошибки

### 4.4 "Размытое" сравнение номенклатуры

Для случаев, когда точное совпадение названия не найдено:

1. **Использовать коэффициент Levenshtein distance:**
   - Порог совпадения: не менее 75% сходства
   - Библиотека: `fuzzywuzzy` или встроенный `difflib`

2. **Частичное совпадение по ключевым словам:**
   - Выделить ключевые слова (например: "подвески", "пакеры", "муфта")
   - Найти строки в справочнике, содержащие все ключевые слова
   - Если найдено более одного — выбрать с наибольшим процентом совпадения

3. **Поиск по коду номенклатуры:**
   - Если в названиях есть коды (например, "ОНГ.216.00.000-01-032") — сопоставить по коду как приоритет

---

## 5. Технические требования

### 5.1 Язык и зависимости

- **Язык:** Python 3.8+
- **Основные библиотеки:**
  - `pandas` — обработка табличных данных и фильтрация
  - `openpyxl` или `xlsxwriter` — работа с форматированием Excel
  - `re` — регулярные выражения для парсинга дат и кодов
  - `python-dateutil` — парсинг дат в разных форматах
  - `difflib` или `fuzzywuzzy` — "размытое" сравнение строк
  - `logging` — подробное логирование (встроенный модуль)

### 5.2 Структура приложения

```
ExcelFlow/
├── main.py                 # Точка входа, парсинг аргументов
├── processors/
│   ├── __init__.py
│   ├── data_loader.py      # Загрузка и валидация файлов
│   ├── parser.py           # Парсинг и нормализация данных
│   └── matcher.py          # Логика сопоставления
├── utils/
│   ├── __init__.py
│   ├── date_extractor.py   # Извлечение и парсинг дат
│   ├── fuzzy_matcher.py    # "Размытое" сравнение
│   └── logger_config.py    # Конфигурация логирования
├── tests/
│   ├── test_parser.py
│   ├── test_matcher.py
│   └── test_date_extractor.py
├── requirements.txt        # Зависимости проекта
└── README.md               # Документация
```

### 5.3 Интерфейс командной строки

```bash
python main.py --input <путь> --output <путь> [--source-sheet] [--target-sheet] [--log-level]
```

**Параметры:**

| Параметр | Тип | Описание | Обязательный |
|----------|-----|---------|------------|
| `--input` | string | Путь к входному Excel-файлу | Да |
| `--output` | string | Путь к выходному Excel-файлу | Да |
| `--source-sheet` | string | Имя вкладки-справочника | Нет (по умолчанию: "ВП 2024-2025 НЧТЗ") |
| `--target-sheet` | string | Имя вкладки для обработки | Нет (по умолчанию: "СК ТПХ_1 пг") |
| `--log-level` | string | Уровень логирования (DEBUG, INFO, WARNING, ERROR) | Нет (по умолчанию: INFO) |
| `--report-file` | string | Путь к файлу отчёта о несопоставленных записях | Нет |

**Примеры использования:**

```bash
# Базовое использование
python main.py --input данные.xlsx --output результат.xlsx

# С пользовательским путём отчёта
python main.py --input данные.xlsx --output результат.xlsx --report-file отчет.xlsx

# С повышенным уровнем логирования
python main.py --input данные.xlsx --output результат.xlsx --log-level DEBUG
```

### 5.4 Логирование и мониторинг

Приложение должно выводить в консоль и в файл лога следующую информацию:

1. **На этапе инициализации:**
   - Версия приложения и время запуска
   - Проверка входного файла
   - Список найденных вкладок
   - Количество строк в каждой вкладке

2. **На этапе обработки (INFO уровень):**
   - Прогресс обработки (каждые N записей: 0%, 25%, 50%, 75%, 100%)
   - Статистика по видам совпадений (точное, Уровень 1, Уровень 2, размытое)

3. **На этапе обработки (DEBUG уровень):**
   - Детальная информация о каждом сопоставлении
   - Полученные коэффициенты совпадения
   - Отброшенные кандидаты и причины

4. **По итогам обработки:**
   - **Общая статистика:**
     - Всего обработано записей: N
     - Успешно сопоставлено: M (%)
     - Требует ручной проверки: K (%)
     - Отсутствуют ключевые данные: L (%)
   - **Распределение по типам совпадений:**
     - Точное совпадение: X
     - Совпадение по Уровню 1: Y
     - Совпадение по Уровню 2: Z
     - Размытое совпадение: W
   - **Время обработки:** HH:MM:SS

**Пример формата лога:**

```
[2025-01-20 10:15:30] INFO: ============ ExcelFlow v1.0 ============
[2025-01-20 10:15:30] INFO: Входной файл: /home/user/данные.xlsx
[2025-01-20 10:15:30] INFO: Найдено вкладок: 7
[2025-01-20 10:15:30] INFO: Начало обработки...
[2025-01-20 10:15:35] INFO: Обработано: 25% (250 из 1000)
[2025-01-20 10:15:40] INFO: Обработано: 50% (500 из 1000)
[2025-01-20 10:15:45] INFO: Обработано: 75% (750 из 1000)
[2025-01-20 10:15:50] INFO: Обработано: 100% (1000 из 1000)
[2025-01-20 10:15:51] INFO: ========== ИТОГОВАЯ СТАТИСТИКА ==========
[2025-01-20 10:15:51] INFO: Успешно сопоставлено: 950 (95.0%)
[2025-01-20 10:15:51] INFO: Требует ручной проверки: 45 (4.5%)
[2025-01-20 10:15:51] INFO: Ошибки/отсутствуют данные: 5 (0.5%)
[2025-01-20 10:15:51] INFO: Точное совпадение: 800
[2025-01-20 10:15:51] INFO: Совпадение Уровень 1: 100
[2025-01-20 10:15:51] INFO: Совпадение Уровень 2: 50
[2025-01-20 10:15:51] INFO: Размытое совпадение: 0
[2025-01-20 10:15:51] INFO: Время обработки: 00:00:21
```

---

## 6. Требования к обработке особых ситуаций

### 6.1 Несколько совпадений

Если для одной записи найдено несколько подходящих кандидатов:

1. Применить систему приоритизации (см. раздел 3.3)
2. Выбрать кандидата с наивысшим приоритетом
3. В лог DEBUG добавить информацию о отброшенных кандидатах (макс. 3 варианта)

### 6.2 Отсутствие данных

| Сценарий | Действие | Метка |
|----------|---------|-------|
| Нет даты приобретения и нет даты реализации | Пометить и добавить в отчёт | `*ОТСУТСТВУЮТ КЛЮЧЕВЫЕ ДАТЫ*` |
| Нет номенклатуры | Пометить и добавить в отчёт | `*ОТСУТСТВУЕТ НОМЕНКЛАТУРА*` |
| Соответствие не найдено после Уровня 1 и 2 | Пометить и добавить в отчёт | `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*` |
| Размытое совпадение ниже 60% | Считать как не найдено | `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*` |

### 6.3 Файловые ошибки

| Ошибка | Действие |
|--------|---------|
| Входной файл не найден | Завершить с кодом exit(1), вывести: "Файл не найден: [путь]" |
| Вкладка не найдена | Завершить с кодом exit(2), вывести: "Вкладка '[имя]' не найдена в файле" |
| Обязательный столбец отсутствует | Завершить с кодом exit(3), вывести: "Столбец '[имя]' не найден на вкладке '[вкладка]'" |
| Ошибка записи выходного файла | Завершить с кодом exit(4), вывести: "Не удалось записать файл: [причина]" |

---

## 7. Формат выходного файла

### 7.1 Структура вкладки "СК ТПХ_1 пг"

Исходная структура сохраняется полностью. **В конец таблицы (после последнего столбца) добавляются пять новых столбцов:**

| Столбец | Название | Описание | Формат |
|---------|----------|---------|--------|
| Новый +1 | Дата приобретения | Извлеченная из документа дата | DD.MM.YYYY или "*Дата не найдена*" |
| Новый +2 | Квартал приобретения | Квартал, определённый на основе даты | 1 квартал 2025 или пусто |
| Новый +3 | Стоимость закупки НЧТЗ 1 ед | Значение из справочника или метка ошибки | Число (2 десятичных знака) или "*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*" |
| Новый +4 | Прямая СС НЧТЗ 1 ед | Значение из справочника или метка ошибки | Число (2 десятичных знака) или "*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*" |
| Новый +5 | НР НЧТЗ 1 ед | Значение из справочника или метка ошибки | Число (2 десятичных знака) или "*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*" |

### 7.2 Сохранение форматирования

- Исходное форматирование всех ячеек остаётся без изменений
- Новые столбцы получают стандартное форматирование (без жирного, без цвета)
- Шрифт: Arial, размер 11
- Высота строк сохраняется
- Границы ячеек наследуются от соседних столбцов

### 7.3 Отчёт о несопоставленных записях

Если указан параметр `--report-file`, создать отдельный файл Excel с дополнительной вкладкой **"Требует проверки"** содержащей:

| Столбец | Содержание |
|---------|-----------|
| Номер строки | Номер строки из исходной вкладки |
| Номенклатура закупки | Значение из столбца S исходной вкладки |
| Документ приобретения | Значение из столбца V исходной вкладки |
| Извлеченная дата | Результат парсинга документа |
| Найденные кандидаты | Через запятую, столько же сколько найдено |
| Причина | "Дата не найдена", "Не найдено совпадение", "Несколько совпадений", "Низкое качество совпадения" |

---

## 8. Требования к производительности

- **Входные данные:** Excel-файл с 1 000+ записями и 50+ столбцами
- **Максимальное время обработки:** 2 минуты (для 1 000 записей)
- **Максимальное потребление памяти:** не более 500 МБ
- **Рекомендации по оптимизации:**
  - Использовать `pandas` для операций с большими наборами данных (избегать циклов по строкам)
  - Кэшировать результаты нормализации и парсинга дат
  - Использовать индексы для быстрого поиска при сопоставлении

---

## 9. Тестирование

### 9.1 Обязательные тестовые сценарии

#### Тестовый сценарий #1: Полное совпадение с датой приобретения

**Входные данные:**
```
СК ТПХ_1 пг:
- Номенклатура: "Башмак колонный вращающийся БК-Вр.114"
- Документ приобретения: "Реализация товаров и услуг 00КА-000135 от 20.01.2025"

ВП 2024-2025 НЧТЗ:
- Номенклатура завода: "Башмак колонный вращающийся БК-Вр.114"
- Период месяц: "Январь 2025 г."
- Прямая СС на ед: 15000.50
- Стоимость закупки НЧТ: 14000.00
- Прямая материальная составляющая: 13000.00
```

**Ожидаемый результат:**
- Дата приобретения: 20.01.2025
- Квартал приобретения: 1 квартал 2025
- Стоимость закупки НЧТЗ 1 ед: 14000.00
- Прямая СС НЧТЗ 1 ед: 15000.50
- НР НЧТЗ 1 ед: 13000.00

#### Тестовый сценарий #2: Сопоставление по коду номенклатуры без даты

**Входные данные:**
```
СК ТПХ_1 пг:
- Номенклатура: "Муфта резьбовая ОНГ.216.00.000-01-032 (подойди 3/4)"
- Документ приобретения: "Без даты"
- Дата реализации: 15.04.2025

ВП 2024-2025 НЧТЗ:
- Номенклатура завода: "Муфта резьбовая ОНГ.216.00.000-01-032"
- Период месяц: "Апрель 2025 г."
- Прямая СС на ед: 8250.75
- Стоимость закупки НЧТ: 7500.00
- Прямая материальная составляющая: 7000.00
```

**Ожидаемый результат:**
- Дата приобретения: *Дата не найдена*
- Квартал приобретения: 2 квартал 2025
- Стоимость закупки НЧТЗ 1 ед: 7500.00
- Прямая СС НЧТЗ 1 ед: 8250.75
- НР НЧТЗ 1 ед: 7000.00

#### Тестовый сценарий #3: Несоответствие и ручная проверка

**Входные данные:**
```
СК ТПХ_1 пг:
- Номенклатура: "Неизвестная деталь XXX-YYY-ZZZ"
- Документ приобретения: "Дата некорректна"
- Дата реализации: отсутствует

ВП 2024-2025 НЧТЗ:
- Нет совпадающих записей
```

**Ожидаемый результат:**
- Дата приобретения: *Дата не найдена*
- Квартал приобретения: пусто
- Стоимость закупки НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- Прямая СС НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- НР НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- Запись должна быть добавлена в отчёт о проверке

### 9.2 Структура тестов

```python
# tests/test_matcher.py
def test_exact_match_with_date():
    """Тест точного совпадения с датой приобретения"""
    # Arrange, Act, Assert
    pass

def test_match_by_code_without_date():
    """Тест сопоставления по коду без даты приобретения"""
    # Arrange, Act, Assert
    pass

def test_no_match_manual_review():
    """Тест отсутствия совпадения и отправки на ручную проверку"""
    # Arrange, Act, Assert
    pass

# tests/test_date_extractor.py
def test_date_parsing_standard_format():
    """Тест парсинга стандартного формата даты"""
    pass

def test_date_parsing_invalid_format():
    """Тест обработки некорректного формата даты"""
    pass

# tests/test_parser.py
def test_nomenclature_normalization():
    """Тест нормализации названия номенклатуры"""
    pass

def test_quarter_determination():
    """Тест определения квартала по дате"""
    pass
```

---

## 10. Примеры обработки

### Пример 1: Успешное сопоставление

```
Входные данные:
- Столбец S: "Подвески штангового глубинного насоса ПШГН Х-70-5"
- Столбец V: "Реализация товаров и услуг 00КА-000207 от 15.02.2025 14:30:00"

Процесс обработки:
1. Извлечение даты: 15.02.2025
2. Определение квартала: 1 квартал 2025 (февраль)
3. Нормализация: "подвески штангового глубинного насоса пшгн х-70-5"
4. Поиск в справочнике: найдено совпадение по номенклатуре + периоду
5. Получено значение: AQ=11000.00, AR=12750.25, AS=12000.00

Выходные данные:
- Дата приобретения: 15.02.2025
- Квартал приобретения: 1 квартал 2025
- Стоимость закупки НЧТЗ 1 ед: 11000.00
- Прямая СС НЧТЗ 1 ед: 12750.25
- НР НЧТЗ 1 ед: 1200.00
```

### Пример 2: Сопоставление по коду

```
Входные данные:
- Столбец S: "Цемент. муфта ЦМВ.32.00.000-03.4.2023 (2 шт.)"
- Столбец V: "Запрос 12345"
- Столбец D: "01.03.2025"

Процесс обработки:
1. Извлечение даты приобретения: не найдена
2. Определение квартала по дате реализации: 1 квартал 2025 (март)
3. Извлечение кода: "ЦМВ.32.00.000-03.4.2023"
4. Поиск в справочнике по коду + контрагенту + периоду: найдено совпадение
5. Получено значение: AQ=8500.00, AR=9500.00, AS=9000.00

Выходные данные:
- Дата приобретения: *Дата не найдена*
- Квартал приобретения: 1 квартал 2025
- Стоимость закупки НЧТЗ 1 ед: 8500.00
- Прямая СС НЧТЗ 1 ед: 9500.00
- НР НЧТЗ 1 ед: 9000.00
```

### Пример 3: Требует ручной проверки

```
Входные данные:
- Столбец S: "Пакер 5.1/2 трёх-позиционный"
- Столбец V: "Некорректные данные"
- Столбец D: отсутствует

Процесс обработки:
1. Извлечение даты приобретения: не найдена
2. Определение квартала по дате реализации: не возможно
3. Извлечение кода: не найден
4. Поиск по названию: частичное совпадение < 60%
5. Не найдено однозначного соответствия

Выходные данные:
- Дата приобретения: *Дата не найдена*
- Квартал приобретения: пусто
- Стоимость закупки НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- Прямая СС НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- НР НЧТЗ 1 ед: *ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*
- Запись добавлена в отчёт с меткой: "Отсутствуют ключевые данные, низкое качество совпадения"
```

---

## 11. Сроки и ресурсы

| Этап | Описание | Ориентировочная длительность |
|------|---------|------------------------------|
| Проектирование | Архитектура, дизайн модулей | 2-3 дня |
| Разработка парсера | Функции для парсинга дат и номенклатуры | 2-3 дня |
| Разработка логики сопоставления | Реализация Уровня 1 и 2, размытого сравнения | 3-4 дня |
| Работа с Excel | Загрузка, сохранение, форматирование | 2 дня |
| Логирование и мониторинг | Подробные логи и отчёты | 1-2 дня |
| Тестирование | Тестовые сценарии, отладка | 2-3 дня |
| **Итого** | | **13-18 дней** |

---

## 12. Утверждение

Документ актуален на: **14 ноября 2025 года**

**Статус:** Готов к разработке ✅

---

## Приложение: Справочник кодов номенклатуры

| Образец кода | Описание | Регулярное выражение |
|--------------|---------|---------------------|
| ОНГ.216.00.000-01-032 | Типовой код трубных изделий | `[А-ЯЁ]+\.\d+\.\d+\.\d+(-\d+)*` |
| МШГРП.114.015-032-60,00 | Код оборудования | `[А-ЯЁ]+\.\d+\.\d+(-\d+)*` |
| 0.0.0-0-0.0-0-32.23.0-28 | Числовой код | `\d+\.\d+\.\d+(-\d+)*` |
| БК-Вр.114 | Буквенно-цифровой код | `[А-ЯЁ]{2}-[А-ЯЁ]{2}\.\d+` |
