# Руководство пользователя ExcelFlow

## Содержание
1. [Назначение приложения](#назначение-приложения)
2. [Требования к системе](#требования-к-системе)
3. [Установка](#установка)
4. [Подготовка данных](#подготовка-данных)
5. [Запуск приложения](#запуск-приложения)
6. [Параметры командной строки](#параметры-командной-строки)
7. [Результаты обработки](#результаты-обработки)
8. [Анализ результатов](#анализ-результатов)
9. [Решение проблем](#решение-проблем)

## Назначение приложения

ExcelFlow - это консольное приложение, предназначенное для автоматического анализа Excel-файлов с несколькими вкладками. Приложение сопоставляет данные между вкладками по определённым критериям и добавляет результаты расчёта в целевую вкладку без потери исходного форматирования.

Основная цель приложения - подтянуть данные о прямой себестоимости из справочной вкладки во вкладку обработки и создать новый столбец с рассчитанными значениями.

## Требования к системе

- Операционная система: Windows, macOS или Linux
- Python: версия 3.8 или выше
- Достаточное количество оперативной памяти (рекомендуется не менее 1 ГБ)
- Свободное место на диске для входных и выходных файлов

## Установка

1. Убедитесь, что у вас установлена подходящая версия Python:
   ```bash
   python3 --version
   ```

2. Скачайте или склонируйте проект ExcelFlow

3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

4. Проверьте установку, запустив:
   ```bash
   python3 main.py --help
   ```

## Подготовка данных

Приложение работает с Excel-файлом, содержащим как минимум две вкладки:
- "СК ТПХ_1 пг" - основная вкладка для обработки (содержит заказы и поставки)
- "ВП 2024-2025 НЧТЗ" - справочная вкладка с данными о себестоимости

### Обязательные столбцы в "СК ТПХ_1 пг":
- Столбец S: "Номенклатура закупки" - содержит названия номенклатур
- Столбец V: "Документ приобретения" - содержит даты в формате "Реализация товаров и услуг 00КА-000135 от 20.01.2025 23:59"
- Столбец D: "Дата реализации" - альтернативный источник дат (опционально)

### Обязательные столбцы в "ВП 2024-2025 НЧТЗ":
- Столбец I: "Номенклатура завода" - содержит названия номенклатур для сопоставления
- Столбец B: "Период месяц" - содержит периоды в формате "Январь 2025 г."
- Столбец AR: "Прямая СС на ед" - основное значение себестоимости
- Столбец AQ: "Стоимость закупки НЧТ" - значение для приоритизации
- Столбец AS: "Прямая материальная составляющая" - резервное значение себестоимости
- Столбец F: "Контрагент" или "Регистратор" - для проверки по ключевым словам

## Запуск приложения

### Базовый запуск
```bash
python3 main.py --input данные.xlsx --output результат.xlsx
```

### Примеры использования

#### С базовыми параметрами:
```bash
python3 main.py --input "/path/to/your/input.xlsx" --output "/path/to/your/output.xlsx"
```

#### С файлом из материалов задания:
```bash
python3 main.py --input "Материалы/СК_ТПХпродажи_1_пг_2025.xlsx" --output "результат.xlsx"
```

#### С пользовательскими именами вкладок:
```bash
python3 main.py --input данные.xlsx --output результат.xlsx --source-sheet "Моя_справочная_вкладка" --target-sheet "Моя_целевая_вкладка"
```

#### С подробным логированием:
```bash
python3 main.py --input данные.xlsx --output результат.xlsx --log-level DEBUG
```

#### С генерацией отчета о несопоставленных записях:
```bash
python3 main.py --input данные.xlsx --output результат.xlsx --report-file отчет.xlsx
```

## Параметры командной строки

| Параметр | Описание | Пример |
|----------|----------|--------|
| `--input` | Путь к входному Excel-файлу (обязательный) | `--input данные.xlsx` |
| `--output` | Путь к выходному Excel-файлу (обязательный) | `--output результат.xlsx` |
| `--source-sheet` | Имя вкладки-справочника | `--source-sheet "ВП 2024-2025 НЧТЗ"` |
| `--target-sheet` | Имя вкладки для обработки | `--target-sheet "СК ТПХ_1 пг"` |
| `--log-level` | Уровень логирования (DEBUG, INFO, WARNING, ERROR) | `--log-level DEBUG` |
| `--report-file` | Путь к файлу отчёта о несопоставленных записях | `--report-file отчет.xlsx` |

## Результаты обработки

Приложение создает **новый** Excel-файл с результатами обработки. ВАЖНО: не указывайте в качестве выходного файла тот же файл, что и входной, так как это может привести к конфликту.

### Новые столбцы вкладке "СК ТПХ_1 пг":
1. **"Дата приобретения"** - извлеченная и нормализованная дата из документа приобретения
2. **"Квартал приобретения"** - определённый на основе даты квартал (Q1, Q2, Q3 или Q4)
3. **"Рассчитанная себестоимость"** - значение из справочной вкладки или маркер ошибки

### Возможные значения в "Рассчитанная себестоимость":
- Числовое значение - успешно сопоставленная себестоимость
- `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*` - не найдено соответствие
- `*ОТСУТСТВУЮТ КЛЮЧЕВЫЕ ДАТЫ*` - отсутствуют необходимые даты
- `*НЕПОЛНЫЕ ДАННЫЕ: ТРЕБУЕТСЯ КОД НОМЕНКЛАТУРЫ*` - недостаточно данных для сопоставления

## Анализ результатов

### Успешно сопоставленные записи
Записи с числовыми значениями в столбце "Рассчитанная себестоимость" были успешно обработаны алгоритмом.

### Требующие внимания
Записи с маркерами ошибок требуют дополнительной проверки:
- Записи с `*ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ*` - возможно, требуют ручного сопоставления
- Записи с `*ОТСУТСТВУЮТ КЛЮЧЕВЫЕ ДАТЫ*` - необходимо дополнить информацией о датах
- Записи с `*НЕПОЛНЫЕ ДАННЫЕ: ТРЕБУЕТСЯ КОД НОМЕНКЛАТУРЫ*` - необходимо уточнить номенклатуру

### Статистика в логе
В конце обработки приложение выводит статистику:
- Общее количество обработанных записей
- Количество успешно сопоставленных записей
- Количество записей, требующих ручной проверки
- Количество записей с отсутствующими данными
- Распределение по типам совпадений (Уровень 1, Уровень 2, размытое)
- Время обработки

## Решение проблем

### Ошибка: "Файл не найден"
- Проверьте правильность пути к файлу
- Убедитесь, что файл существует и доступен для чтения
- Проверьте, правильно ли указано расширение файла (.xlsx)

### Ошибка: "Вкладка не найдена"
- Убедитесь, что в Excel-файле присутствуют требуемые вкладки
- Проверьте точность написания названий вкладок
- Используйте параметры `--source-sheet` и `--target-sheet` для указания других названий вкладок

### Ошибка: "Столбец не найден"
- Убедитесь, что в вкладках присутствуют требуемые столбцы
- Проверьте, что столбцы находятся в правильных позициях (S, V, D для целевой вкладки; I, B, AR, AQ, AS, F для справочной)

### Медленная обработка
- Убедитесь, что в системе достаточно оперативной памяти
- Закройте другие ресурсоемкие приложения
- Рассмотрите возможность обработки файла по частям, если он очень большой

### Множество записей с "ТРЕБУЕТ РУЧНОЙ ПРОВЕРКИ"
- Проверьте качество данных во входном файле
- Убедитесь, что форматы дат и номенклатур соответствуют ожидаемым
- Проверьте, правильно ли заполнены справочные данные
- Рассмотрите возможность корректировки алгоритмов сопоставления для повышения точности

### Важное замечание о выходном файле
Приложение создает **новый** файл с результатами обработки. Убедитесь, что вы указываете путь к **новому файлу** в параметре `--output`, а не к тому же файлу, что и во входном параметре. Это предотвратит возможные проблемы с перезаписью и блокировкой файлов.

### Проблемы с запуском python
В некоторых системах (например, в Ubuntu/Debian) команда `python` может быть недоступна по умолчанию. В этом случае используйте команду `python3` вместо `python`.